#!/usr/bin/env bash
set -euo pipefail


# As of may 25, 2022, bitwarden/cli is archived
readonly old_repository="bitwarden/cli"
readonly repository="bitwarden/clients"

readonly GITHUB_API_TOKEN=${GITHUB_API_TOKEN:-}
readonly GITHUB_TOKEN=${GITHUB_TOKEN:-$GITHUB_API_TOKEN}

oauth_header=()

if [ -n "${GITHUB_TOKEN:-}" ]; then
  oauth_header=("-H" "Authorization: token $GITHUB_TOKEN")
fi

# hit the github api to get tags
get_versions() {
  local repo="$1"
  local prefix=${2:-}

  curl -s "${oauth_header[@]}" "https://api.github.com/repos/$repo/releases" | \
    cat | \
    grep "tag_name" | \
    cut -f 4 -d \" | \
    grep -E "^$prefix" | \
    while read -r version; do
      echo "${version#"$prefix"}"
    done | \
    sort -V 
}

old_versions=$(get_versions "$old_repository" "")
versions=$(get_versions "$repository" "cli-")
echo "$old_versions"
echo "$versions"
